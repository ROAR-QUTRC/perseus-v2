<?xml version="1.0"?>
<robot name="wheel" xmlns:xacro="http://ros.org/wiki/xacro">

<xacro:macro name="wheel" params="prefix:=^ side:=^ end:=^">
  <link name="${prefix}${end}_${side}_wheel">
    <inertial>
      <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      <mass value="${wheel_mass}"/>
      <!-- Use Y-axis aligned cylinder inertia since wheels rotate around Y axis -->
      <xacro:cylinder_inertia_y m="${wheel_mass}" radius="${wheel_radius}" length="${wheel_length}"/>
    </inertial>
    <visual>
      <!-- Rotate mesh so tread pattern faces outward -->
      <xacro:if value="${side == 'left'}">
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 ${pi}"/>
      </xacro:if>
      <xacro:if value="${side == 'right'}">
        <origin xyz="0.0 0.0 0.0" rpy="0.0 0.0 0.0"/>
      </xacro:if>
      <geometry>
        <mesh scale="0.1 0.1 0.1" filename="file://$(find perseus_description)/meshes/wheel.dae"/>
      </geometry>
    </visual>
    <collision>
      <!-- Rotate cylinder 90Â° around X to align with Y axis (wheel axle) -->
      <origin xyz="0.0 0.0 0.0" rpy="${pi/2} 0.0 0.0"/>
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_length}"/>
      </geometry>
    </collision>
  </link>

  <joint name="${prefix}${end}_${side}_wheel_joint" type="continuous">
    <parent link="${prefix}${end}_${side}_motor"/>
    <child link="${prefix}${end}_${side}_wheel"/>
    <xacro:if value="${side == 'left'}">
      <origin xyz="0.0 ${wheels_y_offset} 0.0" rpy="0.0 0.0 0.0"/>
    </xacro:if>
    <xacro:if value="${side == 'right'}">
      <origin xyz="0.0 ${-wheels_y_offset} 0.0" rpy="0.0 0.0 0.0"/>
    </xacro:if>
    <!-- Axis +Y: positive velocity = forward motion -->
    <axis xyz="0 1 0"/>
    <dynamics damping="0.2" friction="0.3"/>
  </joint>



  <gazebo reference="${prefix}${end}_${side}_wheel">
    <!-- TODO: Fix the material tag (this isn't the proper way to do it, and spits out warnings) -->
    <material>Gazebo/Orange</material>
    <!-- see http://sdformat.org/spec?ver=1.12&elem=collision -->
    <collision>
      <surface>
          <friction>
              <ode>
                  <!--
                  Skid-steer friction setup:
                  - mu: friction in fdir1 direction (forward/backward rolling)
                  - mu2: friction perpendicular to fdir1 (sideways sliding for turning)
                  - fdir1: primary friction direction in link frame
                  -->
                  <!-- Forward/backward friction - high to grip and drive -->
                  <mu>1.5</mu>
                  <!-- Sideways friction - low to allow skid steering -->
                  <mu2>0.2</mu2>
                  <!-- fdir1 points forward (X) in link frame -->
                  <fdir1>1 0 0</fdir1>
              </ode>
          </friction>
      </surface>
    </collision>
  </gazebo>
</xacro:macro>

</robot>
